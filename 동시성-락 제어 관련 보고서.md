# 1. 콘서트 티켓팅에서 발생할 수 있는 동시성 이슈 사항 
### 1. 금액 충전 / 사용
### 2. 콘서트 좌석 임시 선점


# 2. 적용 가능한 동시성 제어 방식
  ### 1. 낙관적 락 방식
  - 구현난이도 = 쉬움
  - 해당 자원이 있는 테이블에 version을 추가, 검색 시 version의 정보를 획득하고 수정 시 획득한 version과 현재 db에 있는 version을 비교하여 같으면 수정, 다르면 불가 혹은 수정 후 rollback 하는 방식
  - 동시에 요청된 다수의 요청에 대해 (성공케이스 <<<<< 넘을수 없는 무언가 <<<<< 실패 케이스) 성립
  - 재요청이 없다고 가정할 경우 동시요청수에 비례, 커넥션 풀에 반비례 하여 성공케이스의 수가 결정됨
    - 100개의 동일한 요청에 대해 커넥션 풀이 20일 경우 평균 5번의 성공사례가 발생됨
		- 100개의 동일한 요청에 대해 커넥션 풀이 50일 경우 평균 2번의 성공사례가 발생됨
		- 동일한 커넥션에서 같은 version레벨을 가지고 최초의 update가 일어날 경우 version이 up되고
		- 이후의 커넥션에 대해서 이전의 up된 version을 가지기 때문
  - 커넥션타임아웃에 대한 영향은 상대적으로 적음
    - 비동기적으로 이전 순서를 기다리지 않고 동시에 검색, 및 수정이 이루어지기 때문
	- 실행을 보장하려 할 경우 실패시 재시도를 할 수 있으나 구현이 어렵고(while을 통한 반복 혹은 재귀 형식의 반복) 모든 요청이 성공하게될 경우 결국 순차적으로 이루어지기 때문에 낙관적 락과 시간은 비슷하나 소모되는 자원이 많음

  ### 2. 비관적 락 방식
  - 구현난이도 = 매우쉬움
		- 하나의 자원에 여러개의 요청이 동시에 일어날 때 최초로 접근한 요청이 락을 걸어 다른 요청이 접근할 수 없게 만드는 방식
	- 락을 제외한 다른 요소를 베재할 경우 모든 요청이 성공할 수 있는 방식(순차적이기 때문)
	- 커넥션풀에 대한 영향은 비교적 적으나 커넥션타임아웃에 대해 영향을 받음
		- 5초의 커넥션 타임아웃, 20개의 커넥션풀, 하나의 요청을 처리하는 소요시간 500ms라 가정하였을 경우
		- 5초 / 500ms 인 10개의 요청은 성공하나 나머지 10개의 경우 실패하게 됨
	  - 실행에 대한 안전성이 상대적으로 낙관적락보다 유리하다고 판단
  - no_wait 방식 = 최초의 락 이후 검색 시도 시 나머지 요청을 실패 처리하는 방법

# 3. 이슈사항에 대한 동시성제어방식 적용
  ### 1. 금액 충전 => 비관적 락 방식 사용
  - 동시에 여러번의 금액충전을 할 때
		여러번의 실행 중 한번만 실행되게끔 할것 vs 여러번의 요청이 모두 실행도되록 할 것
	- 그 중 금액 충전의 경우 모든 요청이 실행되는것이 합리적이라 판단
	- 이 경우 낙관적 락 + 실패시 재시도 보다 비관적 락이 효율적

  ### 2. 결제 사용 => 낙관적 락 방식 사용
  - 티켓의 경우 재고 관리처럼 결제를 많이할 경우 물건을 많이 사는 형식이 아닌 특정한 1개의 자리에 대한 권리만을 매매하기 때문(사용자 입장에서 지불이 많아지는 것에 대한 대가는 없으나 환불 등의 오히려 복잡한 절차만 있기 때문)
  - 때문에 실행을 보장하는 비관적 락 보단 여러개 중 하나의 성공만을 보장하는 낙관적 락이 적합하다고 판단
  - 결제의 경우 예약 확정 -> 금액 차감 -> 이력저장의 플로우로 진행되기 때문에 예약 확정 되는 부분에 낙관적 락 방식 적용하여 낙관적 락의 실패할 경우의 트랜잭션을 짧게 잡는것이 효율적이라 판단.

  ### 3. 콘서트 좌석 임시 선점 => 낙관적 락 방식 사용
  - 선점한 요청을 제외한 모든 요청에 대해 실패하는것이 오히려 알맞는 방식이기 때문
  - 따라서 순서 및 실행을 보장하는 비관적락 보다 낙관적 락이 적합
  - 비관적락 + no_wait 방식을 고려해보기도 하였지만
    - 낙관적 락의 경우 비동기적으로 처리가 되어 상대적으로 속도에 대한 이점이 크게 낮지 않고
    - no_wait를 추가했을 경우 최초의 요청이 실패하게 되면 나머지 요청들은 다 실패하게 되지만 비관적 락의 경우 현재 실행중인 다른 요청이 update를 할 수 있는 가능성이 있기 때문 
