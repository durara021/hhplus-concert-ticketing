# Kafka 장애 상황 (가상) 대응 문서

---

## 1. 장애 상황 가정
- **장애 상황**:
  - Kafka 브로커 연결 끊김으로 인해 메시지 큐에 데이터가 적재되지 않음.
  - 이벤트 기반 API (좌석 예약 요청, 결제 API 등)의 트랜잭션 처리가 중단됨.
  - Kafka의 소비자(Consumer)와 생산자(Producer) 간 데이터 전달이 실패하여 시스템 기능이 일부 정지.

---

## 2. 원인 추정
1. **네트워크 연결 문제**
   - Kafka 브로커와 클라이언트 간 네트워크 연결 불안정.
2. **브로커 장애**
   - Kafka 클러스터 내 브로커 노드 중 일부 다운.
   - 리더-팔로워 파티션 재조정이 지연되어 메시지 전달 중단.
3. **메시지 과부하**
   - 처리할 메시지 양이 Kafka 큐의 처리 속도를 초과하여 큐 적체 발생.

---

## 3. 장애 대응 방안

### 1. 즉각적 대응
- **Kafka 연결 상태 점검**
  - Kafka 브로커와 클라이언트 간 네트워크 연결 확인 (`telnet`, `ping` 등).
  - `kafka-topics` 명령어를 사용해 브로커의 정상 동작 여부 확인.
- **브로커 재시작**
  - 연결이 끊어진 브로커를 재시작하고 클러스터 재조정 여부 확인.
  - 특정 파티션의 리더를 수동으로 할당하여 메시지 처리를 복구.
- **대체 경로 설정**
  - Kafka 사용 중단 시 대체 큐 시스템(예: Redis Streams)으로 전환.

### 2. 임시 해결 방안
- **Producer 재시도 설정 강화**
  - `retries` 값을 늘려 메시지 재시도를 지속적으로 수행.
  - 타임아웃(`request.timeout.ms`) 및 배치 크기(`batch.size`) 설정 조정.
- **데이터 손실 방지**
  - 메시지 손실 방지를 위해 Kafka의 `Log Retention` 설정을 점검.
  - 메시지를 파일 시스템이나 대체 스토리지로 백업하는 임시 로직 추가.
- **Consumer 재처리 로직 구현**
  - Kafka 장애 이후 메시지 처리를 복구하기 위해 `Consumer Offset` 관리 로직 강화.

### 3. 영구적 해결 방안
- **Kafka 클러스터 확장**
  - 브로커 수를 추가하여 메시지 처리량을 증가시키고 병목을 완화.
- **고가용성(HA) 설정**
  - 다중 브로커 클러스터를 구성하고 리더-팔로워 파티션을 균등하게 분배.
  - Zookeeper와 Kafka 브로커 간 연결 상태를 지속적으로 모니터링.
- **프로듀서 설정 최적화**
  - `acks` 값을 `1`로 설정하여 최소한의 안정성을 유지하면서 타임아웃 방지.
  - 프로듀서의 백오프(Backoff) 전략을 추가하여 네트워크 부하 감소.
- **메시지 큐 대체 설계**
  - 장애 시 Redis Streams, RabbitMQ 등과 연동하여 메시지를 일시적으로 저장하고 복구 후 Kafka로 전송.

---

## 4. 장애 복구 절차

### 1. 장애 탐지
- Kafka 모니터링 도구(e.g., Prometheus, Grafana)를 통해 브로커 상태를 실시간 점검.
- 메시지 처리 실패율 및 소비자 오프셋 미처리 상태 확인.

### 2. 장애 복구 단계
1. 브로커 로그 확인(`server.log`)으로 장애 원인 추적.
2. 브로커가 정상화된 후, `Consumer Offset`을 기준으로 미처리 메시지부터 재처리.
3. 필요한 경우, `kafka-console-producer` 및 `kafka-console-consumer` 명령어로 메시지 전달 복구.

### 3. 테스트 및 검증
- 장애 복구 후 동일한 메시지 전송 시나리오로 테스트 실행.
- 메시지 손실 여부 확인 및 클러스터 상태 점검.

---

## 5. 예상 개선 효과
- Kafka 장애로 인한 메시지 손실 방지 및 복구 속도 개선.
- 프로듀서와 컨슈머의 안정적 연결 유지로 서비스 중단 최소화.
- Kafka 클러스터 확장을 통해 향후 트래픽 증가에 대한 처리 용량 확보.

---

Kafka 장애 대응을 통해 실시간 이벤트 기반 아키텍처의 안정성을 강화하고, 장애 상황에서도 핵심 서비스를 지속적으로 운영할 수 있도록 보장합니다.
